# 4. 网络层

![image-20250507152059739](C:\Users\dww\AppData\Roaming\Typora\typora-user-images\image-20250507152059739.png)

**数据链路层**为网络层提供服务，将网络层的**IP数据报（分组）**封装成帧，传输给下一个**相邻结点**。

![image-20250507153017824](C:\Users\dww\AppData\Roaming\Typora\typora-user-images\image-20250507153017824.png)



## 4.1 网络层的功能

![image-20250507154703973](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507154703973.png)



## **4.2 IPv4分组**



![image-20250507155419748](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507155419748.png)



### 4.2.1 IP数据报的格式

![image-20250607180404805](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250607180404805.png)

**418,首总偏**；首部字段以4B为单位，总长度字段以1B为单位，片偏移字段以8B为单位

---



首部第一行

![image-20250507160455129](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507160455129.png)

**版本字段**

4bit，用来区分IPv4和IPv6

**首部长度**

4bit，bit表示0~15，然后**乘4B字节来表示首部长度**。

**区分服务**

用不到

**总长度**

16bit，表示0~65535，乘1B字节来表示单位，总长度覆盖首部和数据部分。

> 总长度不能大于下层数据链路层的MTU(最大传送单元)，以太网帧1500B



---



首部第二行

**第二行是IP数据报分片相关的。**

**IP数据报分片**

当主机A发出的IP数据报过大，而数据链路层链路承载能力（MTU）小于数据报的长度，则需要把IP数据报分片。

![image-20250507161126929](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507161126929.png)

一个数据链路层能承载的最大数据量，称为最大传送单元（MTU）。

![image-20250507162322232](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507162322232.png)

> 分片可以发生在传输过程源主机和任何一个路由器，但重组只会发生在目的主机。

![image-20250507171940979](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507171940979.png)

分片的好处是各个分片可以选择不同的路径抵达目的主机。

**标识字段**

16bit，由IP数据报的“源主机”生成，通常是自增序列。用来表明是那一个IP数据报，IP数据报的第几个分片。

**标志字段**

3bit，只关注最低位和次低位（0**00**），最低位是MF(More Fragment)表示是否是最后一个分片。次低位是DF(don't Fragment)表示是否允许被分片。

MF=1表示后面还有分片

MF=0表示最后一个分片

DF=1表示不允许被分片

DF=0表示允许被分片

**片偏移字段**

13bit，表示数据部分在“被分片前”的位置，以乘8B为单位。数据报的数据部分也必须是8的倍数B。

---



**第三行**

**生存时间**（TTL）

8bit，如果路由配置错误，数据报可能在网络中无限转发，**TTL是最大转发次数**，保证数据报不会被无限转发。TTL变为0时，路由器直接丢弃该数据报，并且返回**ICMP超时消息**给发送方。

**协议**

8bit，为目的主机标识当前报文的数据部分服务于TCP协议还是UDP协议。

**首部校验和**

16bit，么个路由器仅校验首部，不用校验数据部分。如果全为0，则无需校验。校验和的计算方法与UDP相同（之后学）。





### 4.2.2 IP技术的发展过程

ABCDE分类IP地址——>子网掩码——>CIDP无分类编址——>NAT技术

#### 1.最初版本(ABCDE分类分组)

> IPv4地址占32bit，表示时每8位划分成一个10进制数字。如172.31.255.255

![image-20250507173756917](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250507173756917.png)

>一个B类地址一共
>
>一个C类地址一共

32bit IP地址的两级结构 = <网络号>，<主机号>

- 在那个年代，**要求每台主机、每个路由器接口被分配的IP地址都是全球唯一的**
- **路由器和路由器**连接的接口可以**不分配IP地址**，但路由器和其他节点连接的接口必须**分配IP地址**
- 从属于同一个网络的所有主机、路由器接口的IP地址“网络号”都相同，**网络号就是网络标识** 
- 当一台**新主机接入网络时**，需要给他**分配一个IP地址**、并配置**“默认网关”**（路由器）

> 默认网关就是默认的帮助主机发送信息到不同网段（互联网，隔壁小区）的路由器的接口IP

![image-20250508154728027](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250508154728027.png)

当主机H1向不同网络的主机H7发送数据时，H1先将IP数据报封装为MAC帧，目的MAC地址设为默认网关（通过ARP获取）。网关收到后，剥离MAC帧头部，根据IP数据报的目的IP查询路由表，确定下一跳路由器，并重新封装MAC帧（更新源/目的MAC地址）。该过程逐跳重复，直至数据到达H7所在网络，最后一跳路由器将MAC帧直接发送给H7。**IP数据报的源和目的地址始终不变，而MAC帧的源和目的地址在每一跳链路中更新**，实现跨网络传输。

> MAC帧的数据部分就是IP数据报，发送过程中IP数据报的内容不会变

##### 特殊用途的IP地址

![image-20250508163354466](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250508163354466.png)

> 全0的IP地址用于新接入网络中的主机，此时该主机还没有被分配IP地址

#### 2.子网划分与子网掩码技术

![image-20250508170008040](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250508170008040.png)

**诞生背景：**

随着互联网的快速发展，IPv4地址空间（32位，约43亿个地址）逐渐面临**地址耗尽**和**路由效率低下**的问题。早期IP地址采用**分类编址（A/B/C类）**，导致地址分配不灵活，例如：

1. **地址浪费**：
   - 一个B类网络（如`172.16.0.0/16`）可支持6.5万台主机，但实际组织可能仅需几百个地址，剩余地址被闲置。
2. **路由表膨胀**：
   - 每个网络在路由表中需单独记录，大规模网络导致路由表条目激增，降低转发效率。
3. **管理需求**：
   - 大型机构希望将单一网络划分为多个逻辑子网（如按部门划分），便于隔离广播域和管理权限。

---



##### 子网划分

从主机位分出前 k bit位，来作为子网号，剩余的 n-k bit作为主机号，这样就能划分出 2^k^ 个子网（**每个子网包含的IP地址块大小相等**）。 

划分前，IP地址结构 = <网络号，主机号>

划分后，IP地址结构 = <网络号，子网号，主机号>

>主机号全0表示子网网络本身，主机号全1位子网广播地址，这两个保留

##### 子网掩码

子网掩码是供节点判断IP地址**网络前缀**的标识码。其本质是一串前n位为1、后(32-n)位为0的二进制序列，其中**n表示网络前缀的总位数**（即原网络号与子网扩展位的总和）。网络前缀决定了子网范围，同一子网内的所有设备，其网络前缀通过子网掩码计算后结果完全一致。

> 子网掩码只与网络号和子网号的位数有关，作用就是把网络号和子网号筛选出来，剔除掉主机号。然后**用来判断不同IP的网络前缀是否相同**，相同就是在同一网段。

**示例说明：**

- 子网掩码`255.255.255.192`（二进制`11111111.11111111.11111111.11000000`，即`/26`）表示前26位为网络前缀，后6位为主机位。
- 若IP地址为`192.168.1.65`，其网络前缀为`192.168.1.64`（通过按位与运算得出），同子网内所有IP的网络前缀均为此值。

> 对于没有进行子网划分的网络，可以根据它的IP类型（A类B类C类）给它一个默认的子网掩码。

---



![image-20250509150830935](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509150830935.png)

![image-20250509153556551](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509153556551.png)

![image-20250509153951639](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509153951639.png)

> 查转发表要遵循**最长前缀匹配原则**

##### **示例：H1向H7发送数据的完整流程**

**1. H1检测目的地址并封装MAC帧**

- **H1的IP地址**：`166.1.0.1`
- **H1的子网掩码**：`255.255.128.0`（`/17`）//（/17）是CIDR记法,表示前17位是网络前缀
- **目的IP**：`200.1.1.1`（H7）
- 判断是否同子网：
  - 计算网络前缀：
    - `200.1.1.1 & 255.255.128.0 = 200.1.0.0`
    - `H1的网络前缀`：`166.1.0.0`（通过`166.1.0.1 & 255.255.128.0`得到）
  - **结论**：`200.1.0.0 ≠ 166.1.0.0` → **H7不在子网0**，需通过默认网关转发。
- 封装MAC帧：
  - **目的MAC**：默认网关（学校路由器B3接口`166.1.0.5`的MAC地址，通过ARP获取）。
  - **源MAC**：H1的MAC地址。

**2. 学校路由器处理（B3接口接收）**

- **解封装MAC帧**：剥离帧头，提取IP数据报（源IP `166.1.0.1`，目的IP `200.1.1.1`）。

- 路由表查询：

  |      **目的网络**      |  **子网掩码**   | **转发接口** |
  | :--------------------: | :-------------: | :----------: |
  |      `166.1.0.0`       | `255.255.128.0` | B3（本子网） |
  |     `166.1.128.0`      | `255.255.128.0` |      B2      |
  | **默认路由** `0.0.0.0` |    `0.0.0.0`    |  B1（ISP）   |

- 转发决策：

  - `200.1.1.1`不匹配任何学校子网 → **触发默认路由**，从接口B1发送至ISP路由器A2接口。

- 重新封装MAC帧：

  - **目的MAC**：ISP路由器A2接口的MAC地址（通过ARP或路由表缓存获取）。
  - **源MAC**：学校路由器B1接口的MAC地址。

------

 **3. ISP路由器处理（A2接口接收）**

- **解封装MAC帧**：提取IP数据报，检查目的IP `200.1.1.1`。

- 路由表查询：

  | **目的网络** |  **转发接口**  |
  | :----------: | :------------: |
  | `166.1.0.0`  |   A2（学校）   |
  | `200.1.1.0`  |   A3（公司）   |
  |   其他流量   | 发送至Internet |

- 

  转发决策：

  - `200.1.1.1`匹配公司网络`200.1.1.0/24` → **从接口A3转发至公司路由器C1接口**。

- 重新封装MAC帧：

  - **目的MAC**：公司路由器C1接口的MAC地址。
  - **源MAC**：ISP路由器A3接口的MAC地址。

 **4. 公司路由器处理（C1接口接收）**

- **解封装MAC帧**：提取IP数据报，检查目的IP `200.1.1.1`。

- 路由表查询：

  | **目的网络** |  **子网掩码**   | **转发接口** |
  | :----------: | :-------------: | :----------: |
  | `200.1.1.0`  | `255.255.255.0` | C1（本子网） |

- ARP解析H7的MAC地址：

  - 若缓存中无`200.1.1.1`的MAC，广播ARP请求，H7回复其MAC地址。

- 封装MAC帧并发送：

  - **目的MAC**：H7的MAC地址。
  - **源MAC**：公司路由器C1接口的MAC地址。

 **5. H7接收数据**

- **MAC匹配**：H7检测到目的MAC为本机地址，接收并解封装。
- **IP匹配**：目的IP `200.1.1.1`为本机地址 → **数据交付成功**。

 **流程图示**

```
H1（166.1.0.1） → 学校路由器B3（166.1.0.5） → 学校路由器B1 → ISP路由器A2 → ISP路由器A3 → 公司路由器C1（200.1.1.254） → H7（200.1.1.1）
```

**每一步的MAC地址更新**：

- H1 → 学校网关：目的MAC=学校B3的MAC
- 学校 → ISP：目的MAC=ISP A2的MAC
- ISP → 公司：目的MAC=公司C1的MAC
- 公司 → H7：目的MAC=H7的MAC

---



#### 3.无分类编址CIDR技术

![image-20250509175711316](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509175711316.png)

---



**诞生背景**：子网划分仅仅解决了单个组织内部的地址分配问题，没有缓解全局地址的浪费。（B类网络（/16）支持6.5万台主机，C类网络（/24）仅支持256台主机，但中小型企业仅需几百个地址，被迫申请B类网络。）

**CIDR技术**

取消了A/B/C类的固定IP划分（/8、/16、/24）,允许任意长度的网络前缀（/19、/27）

##### 定长子网划分

和普通的子网划分一样，从主机号中取出 n bit位来作为定长子网号，这样就能划分出2^n^个子网。

> 和传统的子网划分技术同理

##### 变长子网划分

> 定长子网的每个子网都一样大，不够灵活，IP地址利用率低，浪费有限的IP地址资源。
>
> 于是可以进行多次子网划分

在一个CIDR地址块中，划分子网时，子网号长度不固定（每个子网包含的IP地址块大小不同）。

---

##### CDIR子网划分例子

例1：

![image-20250509164659309](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509164659309.png)

可以根据人口数量划分不等的IP地址块大小，最大化IP地址块的利用率。

例2：咸鱼当ISP(互联网服务提供商)

![image-20250509165910392](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509165910392.png)

![image-20250509170040181](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509170040181.png)

解答：

1. 咸鱼有2^5^=32个IP地址资源。
2. 用一位子网号划分，网吧获得4bit主机号，2^4^=16个IP地址，但去除0000和1111作为保留，所以该子网一共获得16-2=14个可分配子网IP地址，其中还有留一个分配给路由器端口。
3. 用两位子网号划分，旺财获得3bit主机号，2^3^=8个IP地址，所有该网络一共获得8-2 = 6个可分配子网IP地址，其中还要分配一个IP地址给路由器端口。

##### **最小子网**

因为全为0和全为1的IP地址要保留作他用（全为0是网络本身地址，全为1是广播地址），而且还需要给与主机相连的路由器接口一个IP地址，**则最小子网需要4个IP地址，即2bit位。**

4. 用三位子网号划分，狗剩获得2^2^=4个IP地址，但实际可用的只有4 - 3 = 1个IP地址（全为1和全为0不能用，且还要给路由器端口一个IP地址）。

---

##### CIDR子网划分技巧（类比哈夫曼树）

![image-20250509174146201](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250509174146201.png)



#### 路由聚合

也称路由汇总或超网，是互联网中通过合并多个连续IP地址块为一个更大的地址块，从而精简路由表的技术。

要求:

1. 使用同一路由器的同一个转发接口。
2. IP地址有最大公共前缀。

> 提取连续IP块的最大公共前缀，然后进行存储

![image-20250608144355225](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608144355225.png)

优点：

1. 节约路由器内存
2. 提高查询速度

**当查询路由表进行转发时，要遵循最长前缀匹配原则**



#### 4.网络地址转换，NAT

![image-20250608154033629](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608154033629.png)

NAT是用来缓解IP地址不够用的问题

---

##### 端口号

是传输层的内容，是各个网络**程序**的虚拟门牌号，实现了进程到进程的通信。  传输层在TCP(或UDP)报文段的首部，指明源端口、目的端口。

传输层定义了2^16^个端口给应用。

> IP地址+端口号=某台设备的特定进程

##### NAT原理

通过划分内网（私有）IP和外网（公有）IP，实现**多个内网设备共享一个外网IP**访问互联网。

> 内网IP是保留出来的IP段，无法访问外网，是具有NAT技术的路由器分配给设备的。

**如何进行转换**

1. 内网设备向外发请求时，NAT路由器将**源IP+源端口**替换为公网IP+新端口

2. 响应返回时，根据端口映射表还原目标设备

<img src="D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608161818134.png" alt="image-20250608161818134" style="zoom:200%;" />

 发送流程如下：

> 1.收发双方的路由器会修改IP地址和端口号
>
> 2.由于端口号是传输层的内容，所以NAT路由器会涉及到传输层，而其他路由器只在网络层工作

源地址：**自己的内网IP地址**端口号

目的地址：接收方路由器的外网IP地址和端口号

然后发送方的路由器接受后，查询NAT表，**修改源地址的IP为外网IP和对应的端口号**，并查询路由表，向着接受方的外网IP发送去。

源地址：**路由器的外网IP地址**端口号

目的地址：接收方路由器的外网IP地址和端口号

接收方的路由器接收后，查询数据包的目的地址上的外网IP地址和端口号，与自己的NAT表对照，**修改目的地址为接收方的内网IP和端口号**，再发送给目的主机。

源地址：发送方路由器的外网IP地址端口号

目的地址：**接收方的内网IP地址**和端口号

自此发送结束。



#### ARP协议

![image-20250608201725802](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608201725802.png)

**是用来获取IP地址对应的MAC地址的。**

1. ARP报文会替换MAC帧里IP报文的位置是两种不同的报文

2. 每个主机和每个路由器都有自己的ARP表

   

---

#### 动态主机配置协议，DHCP

![image-20250608214000111](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608214000111.png)

---

是用来给刚接入网络的主机动态的分配IP地址、配置默认网关、子网掩码等。

![image-20250608213926173](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608213926173.png)

DHCP是应用层协议，主要用于自动配置IP地址。

![image-20250608214218118](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250608214218118.png)

**拥有DHCP的网络的交换机会连接一个DHCP服务器。**

以下图H3接入网络为例

![image-20250611153229591](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611153229591.png)

具体流程如下

![image-20250611153307935](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611153307935.png)

>1. DISCOVER 发现报文
>2. OFFER 提供报文
>3. REQUEST 请求报文
>4. ACKNOWLEDGE 答应报文

具体交互内容如下

![image-20250611153821876](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611153821876.png)

1. 发现报文

当H3接入网络时，广播发送一个携带自己MAC地址的请求报文请求一个IP地址，因为还没有IP地址，也不知道别人的地址，故**目的MAC全1，目的IP全1，源IP全0**（广播帧，广播数据报）。

![image-20250611155402395](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611155402395.png)

其他节点收到后，逐层拆解MAC帧，拆解到UDP数据报（传输层）发现端口不匹配，丢弃。

> DHCP使用的是特定保留端口，不会出现其他节点也有该端口的情况。故可以区别DHCP服务器和其他节点。

2. 提供报文

DHCP服务器收到后，就广播发送一个提供报文，包含给**H3分配的IP地址，组用期，子网掩码，和默认网关**。

由于H3已经通过发现报文向DHCP服务器告知自己的MAC地址，所以服务器可以**发送单播帧**。故其他节点接收不到此次的广播数据报。

> **单播帧里包含广播数据报会使得接收到该帧的交换机仅向目的MAC地址转发该帧**
>
> 正常情况下不会有单播帧里封装广播数据报的情况，这样会使得广播数据报无法广播，也只能单播。

![image-20250611155745322](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611155745322.png)

3. 请求报文

H3向服务器通报自己接受了该IP地址，**其他的都和发现报文一样**，还是没有自己的IP地址，只能广播帧和广播数据报。

这一步的主要目的是**通告其他可能存在的DHCP服务器**，该IP地址我要用了，你们不要再分配给别人。（第一步的发现报文也可能导致多个DHCP服务器向H3分配地址，而H3要选取一个且告诉所有人自己选取的是哪一个）

> 这也是为什么第二步DHCP服务器不向H3通报自己的IP地址，然后他两进行单播的原因，因为还要通知其他可能存在的DHCP服务器。

![image-20250611163234929](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611163234929.png)

4. 答应报文

内容和第2步一样，向H3重发一遍进行确认。

![image-20250611164604629](D:\文献\笔记\408计算机网络\4. 网络层.assets\image-20250611164604629.png)

自此，H3真正有了可以使用的IP地址。





## 4.3 IPv6

采用128位的IP地址，彻底解决IP地址耗尽问题。

主要特点：

1. 更大空间。128位地址。
2. 可以拓展的地址层次结构。
3. 灵活的首部格式。
4. 改进的选项。
5. 允许继续扩充功能。
6. 支持自动配置。
7. 支持资源的预分配。
8. 只有源主机才能分片。
9. 首部长度为固定的40B。
10. 增加了安全性。







## **4.4路由算法与路由协议**





## 4.5 IP多播





## 4.6 移动IP





## **4.7 网络层设备**



