#   3.数据链路层

## 3.1 数据链路层功能概述

![image-20250418173912440](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418173912440.png)

![image-20250418181517132](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418181517132.png)



## 3.2 封装成帧（组帧）

![image-20250418214123802](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418214123802.png)

数据链路层把上层（网络层）交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧。

- 帧的首部和尾部包含有一些重要的控制信息。
- 帧首部和尾部的作用之一就是帧定界。

![image-20250418182815656](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418182815656.png)

### 3.2.1 主要问题

####  帧定界

如何使得接收方在连续的比特流中区别每一帧？

####  透明传输

- 透明传输是指**数据链路层对上层交付下来的协议数据单元PDU没有任何限制**，就好像数据链路层不存在一样。 

  > 就是通过不加限制的给上层提供服务，使得上层在使用数据链路层服务时不用考虑数据链路层的任何限制。来达到数据链路层好像对上层来说隐形了一样。

### 3.2.2 四种组帧的方法

#### 字符计数法

在每个帧的开头用一个固定长度的计数字段表示帧长。

> 帧长 = 计数字段长度 + 帧的数据部分长度
>
> 缺点是，任何一个计数字段出错，都会导致后续所有帧无法定界

![image-20250418210617499](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418210617499.png)

#### 字节填充法

使用控制字符SOH（start of head）和EOT（end of transmission）,他两都属于ASCII编码中的控制字符。用SOH和EOT来标记帧的开始和结束，从而解决帧定界的问题。

![image-20250418211341621](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418211341621.png)

但是帧的数据部分可能会包含SOH和EOT，从而导致混乱。因此，但帧的数据部分出现控制字符SOH和EOT时，要在他们前面添加转义字符（ESC ,escape character），使得接收方能够正常识别。

> 数据部分出现转义字符时，也要在转义字符前添加转义字符。

![image-20250418211630761](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418211630761.png)

![image-20250418212041452](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418212041452.png)

#### 零比特填充法

 约定以`01111110`（0 + 6个1 + 0）组成特殊比特串，来表示帧的开始和结束。当数据部分同样出现`01111110`时，在第五个1后面填充一个0，使出现的部分变成`011111010`。从而避免发生混乱。

**HDLC协议和PPP协议采用了零比特填充法**

![image-20250418212539228](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418212539228.png)

#### 违规编码法

以曼彻斯特编码为例：

由于曼彻斯特编码在一个传输周期中一定会发生跳变。而不发生跳变的传输周期则视为违规。则可以利用这种违规来标记每一帧的开头和结尾。

![image-20250418213656259](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418213656259.png)

## 3.3 差错控制

使用差错检测技术来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

![image-20250418214437047](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250418214437047.png)

> 丢弃重传将在“可靠传输”功能中探讨

###  3.3.1  检错编码

发送方的数据链路层采用某种检错技术，在帧的尾部插入**帧检错码FCS**。接受方的数据链路层采用与发送方相同的检错技术，就可以通过检错码，检测出帧在传输过程中是否出现了误码。

> 帧尾部用来存放帧检错码的字段，称为帧检验序列FCS

#### 奇偶校验码

![image-20250419154127950](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419154127950.png)

![image-20250419165844947](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419165844947.png)

偶校验更常用，因为：

偶校验的硬件实现：把信息位进行异或（模2加）运算，得到的结构即为偶校验位。

接收方检验方法：

把“偶校验”的信息位、校验位全部异或，若结果为0，则说明没有错误

####  CRC校验码

循序冗余校验（CRC码，Cyclic Redundancy Check，CRC）

![image-20250419155729199](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419155729199.png)

##### 以发送方举例

以待发送数据101001，生产多项式G(X) = X^3^ + X^2^ + 1，计算冗余码。

**第一步 构造“被除数”**

待发送数据后面添加生成多项式最高次数个0。

本例中**G(X)的最高次为X^3^**，所以就在待发送数据后面**添加3个0**，形成**被除数**。

`101001（待发送数据） + 000（生成多项式最高次数个0） = 101001000（被除数）`

**第二步 “构造除数”**

生成多项式各项系数构成的比特串作为除数。

**第三步 做“二进制模2除法”**

相当于对于位进行**逻辑异或运算**

![image-20250419170021568](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419170021568.png)

![image-20250419161756758](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419161756758.png)

**第四步 检查"余数"**

**余数的位数**应与**生成多项式最高次数**相同，如果位数不够，则在余数前**补0**来凑足位数。即得到**冗余码**。

由上式可知，余数为1，而生成式的最高次为3，则在余数前面补2个零，来凑够3位。

即**冗余码为001**。

最后，把冗余码添加到待发送数据的后面进行发送，就完成了发送方的循环冗余检测内容。

> 发送101001（待发送数据） + 001（冗余码） =101001001（实际发送）

##### 接收方的步骤

与发送方类似，不再赘述。

![image-20250419165209529](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419165209529.png)

> 详细的过程如下：

![image-20250419155921446](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419155921446.png)

![image-20250419160110478](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250419160110478.png)

###  3.3.2 纠错编码

纠错编码不仅能监测错误，还能自动纠正错误。

#### 海明码

分组进行偶校验，多个校验位。**海明码有1bit位的纠错能力，2bit位的检错能力**。



![image-20250421151023618](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421151023618.png)

步骤总览如下：

![image-20250421214529633](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421214529633.png)

##### 1.需要多少个校验位

检错编码因为只有一位，所以只能携带对/错两种信息。为了实现纠错的能力，需要更多的校验位。

假设有n个信息位，k个校验位，则一共有n+k位。而k个校验码一共可以携带2^k^个信息。

所以要使得

**$2^k\ge n+k+1$ （+1是为了包含传输正确时的状态 ）**

成立。

以下是有n个信息位时，k的选取范围

![image-20250421205943211](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421205943211.png)

##### 2.校验位的位置分布

假设信息为 1010，则信息位n=4,校验位k=3举例：

信息位：D~4~D~3~D~2~D~1~

校验位：P~3~P~2~P~1~

则对应的海明码为H~7~H~6~H~5~H~4~H~3~H~2~H~1~

![image-20250421211107588](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421211107588.png)

**汉明码规定，校验位 P~i~ 必须放在海明位号为 2^i-1^ 的位置上，信息位按顺序放在其余的位置。**

##### 3.求校验位的值

第一步，把海明码中信息位的位号转化成2进制

 ![image-20250421211542760](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421211542760.png)

由图可知，信息位为H3，H5，H6，H7。

H3 = 011

H5 = 101

H6 = 110

H7 = 111

第二步，把由三位数构成的二进制编号，进行分组。

把二进制的H3，H5，H6，H7的位号按照1号位2号位2号位（从低到高）进行分组，对应P1，P2，P3，即

![image-20250421212224508](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421212224508.png)

P1与1101相关

P2与1011相关

P3与0111相关

第三步，计算校验位的值

P~1~的1101分别来自H~3~，H~5~，H~6~，H~7~，其中值为1的分别是H~3~，H~5~，H~7~，则把H~3~，H~5~，H~7~（对应信息位D~1~D~2~D~4~）的值进行异或运算，得到P~1~的值。

同理可得P~2~ P~3~ 

![image-20250421213722936](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421213722936.png)

##### 4.如何纠错

假如正确的海明码为1010010，接收方接收到的信息也为1010010。

我们通过把校验位和与校验位有关的信息位进行异或运算，正确的情况下应该得到0。

![image-20250421214104807](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421214104807.png)

假如接收方接受到的是1010000

则有

![image-20250421214149923](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421214149923.png)

计算得到的S~3~S~2~S~1~=010，对于10进制数字2，则表海明码的第二位出现了错误。

![image-20250421214346499](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421214346499.png)

##### 补充：

通常还会在最首部添加一个全校验位，保证海明码里有偶数个1。

![image-20250421215252866](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250421215252866.png)

 

## 3.4 可靠传输和流量控制机制

![image-20250422175046937](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422175046937.png)

可靠传输这个概念，存在于计算机网络的大多数层。发生在**数据链路层叫帧丢失**，发生在数据链路层**往上的层就叫分组丢失**。

**差错控制**主要解决**位错误**，而**可靠传输**要解决**帧错误**。

以下三种协议，都依靠滑动窗口机制来实现。

### **滑动窗口机制**

![image-20250422175538988](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422175538988.png)

我们规定发送窗口为W~T~，接收窗口为W~R~

且**W~T~ + W~R~ <= 2^n^**，其中 n 为需要的分组编码的位数。

**滑动窗口协议是指GBN协议和SR协议**

> 即传输数据需要的给帧编码的位数。

#### 术语补充

滑动窗口协议：指GBN协议和SR协议

ARQ协议（Automatic repeat request，自动重传请求协议）：指S-W协议

连续ARQ协议：GBN和SR

---



### 3.4.1 停止-等待协议（Stop-and-Wait, S-W）

![image-20250422210414489](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422210414489.png)

只需要1bit位来给分组编号。编号和帧类型（数据帧和确认帧）存储在帧的首部和尾部。

![image-20250422180404005](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422180404005.png)

在确认、否认和重传机制外，还需要解决分组丢失的情况，所以还有**超时重传机制**。

> RTT,Round-Trip Time,往返时间，表示数据包从发送端到发出到接收端确认，返回所经历的时间。
>
> RTO,Retransmission Timeout，重传超时。

![image-20250422180445943](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422180445943.png)

当接收方的ACK发送失败时，会导致发生方触发超时重传机制，由此会导致分组重复的错误。

> 此时接收方需要
>
> 1.丢弃重复分组。2.重新发送重复分组的确认分组。

![image-20250422181107932](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422181107932.png)



因此要给数据分组和确认分组ACK编号，用0和1区分即可。

#### 注意事项：

![image-20250422205938299](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422205938299.png)

![image-20250422212516145](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422212516145.png)

RTT较大时，不适合使用S-W协议。（利用率低）

![image-20250422212220825](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422212220825.png)



---

   

### 3.4.2 后退N帧协议（Go,-back-N, GBN）

![image-20250423164414237](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423164414237.png)

---

由于S-W协议对于RTT>>T~D~（传播时延远大于发送时延），的情况，信道利用率很低。

![image-20250422213117834](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250422213117834.png)

因此可以采用连续发送，不等待每一份确认分组的形式。来提高信道利用率。

- 但也**不能无限制的连续发送数据分组**，因为会使得接收方来不及处理，从而浪费网络资源。
- 回退N帧协议采用连续传输的方式，并且利用**发送窗口来限制**发送方的连续发送分组数量，这属于连续ARQ协议。

---

#### 协议内容

**后退N帧协议规定，发送窗口W~T~>1，接受窗口W~R~=1，**以此来实现流量控制。

> 1< W~T~ <=(2^n^ - 1)  W~T~超过上限，无法分辨新旧数据分组，其中n是为数据分组编号所用的bit位数

按照协议，发送窗口发送连续的多个数据分组，接收方逐个接受，并返回确认分组 ACK ~i~ 。发送窗口接收到ACK ~i~ 后出窗口发送移动，并继续发送窗口内未发送的数据分组。

协议还规定，接收方接收到后，可以**“累计确认”**，即不要逐个发送分组的确认分组，**仅发送最后一个收到的分组的ACK ~i~ 即可**。此时，视为ACK ~i~ 之前的数据分组都已经正常接受无误。

#### 异常情况示例

![image-20250423162449674](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423162449674.png)

假设发送方在发送数据分组D、E、F 时，数据分组E在传输过程中丢失或错误，则接受方无法正常接受数据分组E，此时接受方则返回确认分组ACK~3~来表示D分组被正常接受。（而同期发送的E没有成功接受，而F则因为没有在接受窗口内而被丢弃。）此时发送方的滑动窗口位移，然后开始发送E、F、G（触发了E的超时重传）。其中E、F是第二次被发送。以上过程就是后退N帧协议中，“后退”的由来。

### 3.4.3 选择重传协议（Selective Repeat, SR）

![image-20250423211836559](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423211836559.png)

> 只有SR协议有否认分组，有请求重传机制。

#### 协议内容

  为了进一步提高数据利用率，只重传出现差错的分组。这就需要让W~R~ >1。

<img src="D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423185610320.png" alt="image-20250423185610320" style="zoom:67%;" />

> 实际应用中，通常让W~R~=W~T~

协议规定，**不能采用累计重传机制**，必须对每一个正确的分组进行**逐一确认**。

**请求重传机制**，接收方接收到有差错的分组时，还可以主动发送否认分组，来提前让发送方重新发送信息。

#### 异常情况示例

![image-20250423203122922](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423203122922.png)

**分组丢失**

如图所示，发送方在发送E、F、G、H时，F没有发送到位，接收方只接收到了E、G、H的数据，此时接收方就像发送方发送EGH的接受确认分组ACK。发送方因此滑动一格发送窗口，然后因为没有等到F的接受确认报文，于是触发超时重传机制，向发送方重传F分组和其他尚未发送但在发送窗口内的数据分组。



### 3.4.4 三种协议的信道利用率***

![image-20250425185144625](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425185144625.png)

---

信道利用率就是**发送数据分组的时间占总发送周期的占比**（以发送数据分组到接收到确认分组为一个周期）。

#### S-W协议的信道利用率

![image-20250423213428128](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250423213428128.png)

我们把发送和接受的信道看做两个单独的单向信道，图为发送信道的信道利用率。

> 确认帧一般很短，所以确认帧的传输时延通常忽略不计

#### GBN协议、SR协议的信道利用率

 ![image-20250425182855408](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425182855408.png)

>信道利用率最大为1

## 3.5 介质访问控制

什么是介质访问控制？

 介质访问控制（Medium Access Control，MAC）是计算机网络中**数据链路层的一个关键子层**，负责管理多个设备在共享传输介质上的通信，确保数据高效、有序地传输，避免冲突。

以下有三种实现方法：

![image-20250425195210100](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425195210100.png)

### 3.5.1 信道划分

#### 时分复用（TDM）、统计时分复用（STDM）

1. Time Division Multiplexing，TDM 时分复用 

把时间分为**等长的“TDM帧”**，每个“TDM帧”又分为**等长的m个“时隙”**，将m个时隙分配给m对用户（节点）使用。

![image-20250425200234632](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425200234632.png)

缺点：

- 每个节点最多只能分配到信道总带宽的1/m
- 如果某节点暂不发送数据，会导致被分配的“时隙”闲置，信道利用率低

 Statistic Time Division Multiplexing，STDM 统计时分复用

又称**异步时分复用**，在TDM的基础上，**动态按序分配时隙**

假如BC暂时不需要传输数据，只有A需要传输数据，则把原属于BC的时隙分配给A。使得信道利用率更高



#### 频分复用（FDM）、波分复用（WDM）

Frequency Division Multiplexing，FDM

是**将信道的总频带划分为多个子频带**，每个子频带作为一个子信道，对每个用户使用一个子信道进行通信。

  ![image-20250425201624336](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425201624336.png)

优点：各个节点可以同时发送信号：重复利用了信道带宽（Hz）

缺点：FDM技术只能用于模拟信号的传输

 

Wavelength Division Multiplexing，WDM

即光的频分复用，用光纤传输时的方法，光的频带范围很大，适合采用波分复用技术。

#### 码分复用（CDM）难

CDM技术允许信号互相干扰，互相叠加。接受方有办法将来自各节点的信号值“分离”出来。

![image-20250425204835287](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425204835287.png)

---

##### 第一步 给各节点分配专属“码片序列”

给各个节点分配专属“码片序列”，即取值为1或-1的m维向量。切各个节点间的“码片序列”必须相互正交。

![image-20250425211024645](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425211024645.png)

##### 第二步 发送方如何发送数据

节点发送与“码片序列”相同的信号值则表示二进制1，相反则为-1。

<img src="D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425211238518.png" alt="image-20250425211238518" style="zoom:67%;" />



##### 第三步 信号在传输过程中“叠加”

因为没有任何区分措施，C节点在同时接收到AB节点发来信号时，信号会处于“叠加”的状态。

![image-20250425211309719](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425211309719.png)



##### 第四步 接收方如何接收数据

把各个节点的“码片序列”与接收到的叠加的信号作“规格化内积”。

> 规格化内积：
>
> 就是向量点乘，然后再除以码片的模长。

由于正交的缘故，不同的“码片序列”作内积会得0。因此只会保留两个码片序列相乘的运算，相当于向量的模运算。再乘1/m，就分离得到了叠加信号中各个节点发来的数据。

<img src="D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250425211337545.png" alt="image-20250425211337545" style="zoom:80%;" />

### 3.5.2 随机访问

![image-20250427160255758](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427160255758.png)

#### ALOHA协议

Additive Links On-line Hawaii Area，随机接入多址协议。

**核心思想是用户随时发送数据，发生冲突后随机等待一段时间后重传。**（卫星通信、早起WIFI）

用户有数据时立刻重传，不检测信道是否空闲。

纯ALOHA

![image-20250426172812159](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250426172812159.png)

![image-20250427153502087](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427153502087.png)



时隙ALOHA

将时间划分成固定时隙，用户只能在时隙起点发送数据。一定程度上降低了冲突发生的概率。

![image-20250426172829837](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250426172829837.png)

![image-20250427154028814](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427154028814.png)



#### CSMA协议

CSMA(Carrier Sense Multiple Access)协议，即载波**监听**多路访问协议。CSMA协议在ALOHA协议基础上提出改进：**在发送数据之前，先监听信道是否空闲，只有信道空闲时，才会尝试发送。**

##### 1-坚持CSMA协议

持续监听等待信道空闲。

![image-20250427154638927](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427154638927.png)

 缺点：是当多个节点都已经准备好数据时，一旦信道空闲，会有多个节点同时发送数据，冲突概率大。

##### 非坚持CSMA协议

![image-20250427155144923](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427155144923.png)

信道不空闲时，随机等待一段时间后再次监听。

缺点：信道刚恢复空闲时不会立刻被利用，降低了一定的信道利用率。

##### P-坚持CSMA协议

![image-20250427155749379](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427155749379.png)

当信道空闲时，有P的概率立刻发送数据，1-P的概率推迟一段时间后重新监听信道。

可以根据网络负载量，通过灵活的调整P值来在1坚持和非坚持之间切换，从而提高信道利用率。

#### **CSMA/CD协议**

用于早期的有线以太网（总线型）

CSMA/CD(Carrier Sense Multiple Access Collection Detection)协议,载波监听多路访问/冲突检测。

  ![image-20250427162728918](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427162728918.png)

---

  ![image-20250427165545292](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427165545292.png)

检测到冲突后采用：

##### 二进制指数退避算法

检测冲突的次数，每冲突一次，退避窗口（等待时间范围）**指数级扩大**。

发生冲突后，随机等待一段时间。等待时间的计算方法如下：

K为发送该帧时发生的冲突次数。

![image-20250427171633564](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427171633564.png)

大于10时不再增大退避窗口。

K大于16时直接放弃发送，并且报告上层。

##### 争用期

争用期 = 2 * 最大单向传播时延（考虑举例最远的两个节点）。

争用期就是相距最远的两个节点可能发生冲突的最长时间。即如果可能发生冲突，则只会在这个期间发生冲突。

> 假设AB相距最远，此时当A发送的第一个bit到达B时，B就会因为检测到信道不空闲，从而无法发送，也就无法进行冲突。
>
> 如果A发送的第一个bit到达B之前，B也开始发送，则就会发生冲突。取A到达B的极限距离(可以近似的看做AB间的单向传播时延)，B也开始发送，但检测到A的发送后停止发送。则B发送一点点数据到达A的时间也是AB间的单向传播时延。则A发送数据到检测到B也在发送数据的最大时间为2 * 单向传播时延。

![image-20250427172143150](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427172143150.png)

##### 最短帧长

最短帧长 = 2 * 最大单向传播时延 * 信道带宽  = **争用期 * 信道带宽**

因为发送冲突时，双方发送的数据都会突然暂停，因此不是完整的有效数据。

所以**发送时间超过争用期的数据，才能保证是完整的数据**（争用期内的数据可能是突然暂停的半截数据）。

  <img src="D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427175144082.png" alt="image-20250427175144082" style="zoom: 67%;" />

##### 最长帧长

规定最长帧长，以防止信道被某些节点长期占用

##### 以太网规定

**最短帧长 = 64B字节 ；最长帧长 = 1518B字节**



#### **CSMA/CA协议**

![image-20250427210311323](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427210311323.png)

用于IEEE 802.11无线局域网（WIFI）

CA指Collision Avoidance。指冲突避免

与有线网络的CSMA/CD不同，CSMA/CA通过主动避免冲突而非检测冲突来提高效率。

![image-20250427202118645](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427202118645.png)

---

##### 无线通信的新问题

CSMA/CD协议是一边发送一边监听，检测到冲突就立即停发。

CSMA/CA协议在发送过程中不用检测冲突。发送前想办法尽量避免冲突（但无法完全避免）。

家用路由器 = 路由器+交换机+AP

无线网络无法实现冲突检测，因为有线网络的冲突检测CSMA/CD协议依靠链路的电压变化。无线网络无法实现。

![image-20250427210145597](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427210145597.png)





![image-20250427210956332](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427210956332.png)

DIFS是最长的帧间间隔。

SIFS最短帧间间隔是用来给无线传播进行差错控制 纠错的。

##### ”随机退避“原理

1. 用二进制指数退避发退避一段随机的时间。
2. 发送方会保持监听信道，只有信道空闲时才会“扣除倒计时”，倒计时结束后立即发送帧

##### 信道预约机制（握手机制）

- **RTS（Request to Send）**：发送方请求信道使用权。
- **CTS（Clear to Send）**：接收方确认可接收数据，并通知周围节点保持静默。
- 通过RTS/CTS解决**隐藏终端问题**，但会增加开销（小数据帧可能不用）。

其他节点接收到CTS后自觉禁言一点段时间，被称为虚拟载波监听机制。

![image-20250427212408188](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250427212408188.png)

---

##### 为什么需要等待DIFS时间

防止覆盖其他节点优先级更高的SIFS和ACK。DIFS的时间一般等于SIFS + 2 * 时隙时间。 

### 3.5.3 轮询访问

#### 令牌传递协议

![image-20250428181214175](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428181214175.png)

Token Passing Protocol，

令牌环网技术：IBM公司于1984开发的一种局域网技术。(和CSMA/CD同一时期)

核心特点：环形拓扑结构，各节点“**轮询访问**”信道，不会发生信道冲突。

如何实现“介质访问控制”：令牌传递协议。

---

#### 工作原理

 **令牌传递协议（Token Passing Protocol）详解**

 **1. 基本概念**

**令牌传递协议（Token Passing Protocol）** 是一种用于**共享介质网络**（如令牌环网、令牌总线）的**介质访问控制（MAC）方法**。其核心思想是通过一个特殊的控制帧——**令牌（Token）**，在节点之间依次传递，只有持有令牌的节点才有权发送数据，从而避免冲突并确保公平性。

------

 **2. 工作原理**

**(1) 令牌的传递**

- 网络初始化时，生成一个**电子令牌**（通常是一个特定的比特序列）。
- 令牌按照**预定的顺序**（如物理环或逻辑顺序）在节点间传递。
- **只有持有令牌的节点可以发送数据**，其他节点只能监听或转发数据。

 **(2) 数据发送流程**

1. 等待令牌：节点监听信道，直到收到令牌。
2. 发送数据：
   - 如果节点有数据要发送，则占用令牌，发送数据帧。
   - 如果无数据，则立即将令牌传递给下一个节点。
3. 令牌释放：
   - 发送完成后，节点必须释放令牌（即使还有数据待发送，防止垄断）。
   - 令牌被传递给下一个节点，继续循环。

 **(3) 令牌的维护**

- **丢失检测**：如果令牌长时间未被传递（如节点故障），网络会触发**令牌恢复机制**（如选举新令牌）。
- **优先级控制**：某些协议允许高优先级节点在特定条件下抢占令牌。

![image-20250428180937800](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428180937800.png)

---

#### MAU--令牌环网的集中控制站

![image-20250428181057760](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428181057760.png)

![image-20250428181149603](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428181149603.png)





## 3.6 局域网

### 3.6.1 局域网和IEEE802

IEEE是电气电子工程师学会，IEEE 802委员会是负责推进局域网技术的标准化工作。

<img src="D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428184248306.png" alt="image-20250428184248306" style="zoom: 200%;" />

802.3代指有线以太网技术，802.11代指无线WIFI技术。  

![image-20250428184646328](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428184646328.png)

逻辑链路控制子层和介质访问控制子层属于数据链路层。

---

### 3.6.2 局域网的基本概念和体系结构 

左半部分                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

![image-20250428193448030](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428193448030.png)

右半部分

关注黄色方框内的内容

![image-20250428190649056](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428190649056.png)

### 3.6.3 以太网 和 IEEE802.3

![image-20250501171215721](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501171215721.png)

数据链路层被拆分为

- 逻辑链路控制子层
- 介质访问控制子层

![image-20250428193745235](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428193745235.png)



####   以太网标准物理层![image-20250428204700327](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250428204700327.png)

传输效率小于2.5Gbps时，可选全双工还是半双工（节点进行协商），大于2.5Gbps时，只有全双工。

> 同轴电缆仅支持半双工。
>
> 双绞线二者都可，看具体情况。
>
> 光纤只支持全双工。

##### 双绞线以太网

![image-20250430212359096](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250430212359096.png)

#### 介质访问控制子层 MAC层

 ![image-20250430212543657](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250430212543657.png)

##### **V2标准的 以太网MAC帧**

**6 6 2 N 4**分别对应 **收 发 协 数 验**

![image-20250430212644992](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250430212644992.png)

> IEEE标准和V2标准的区别是：
>
> IEEE的 “指明网络层协议位置” 为 “数据部分的长度”。

#### 单播帧、广播帧如何传播

![image-20250501164814524](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501164814524.png)

路由器接收到广播帧后，不会广播到其他网络。

##### 冲突域和广播域

![image-20250501165003725](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501165003725.png)

> 交换机隔离冲突域，但不隔离广播域
>
> 路由器隔离广播域，也隔离冲突域
>
> 集线器什么也不隔离

### 3.6.4 虚拟局域网VLAN的基本概念与基本原理

VLAN虚拟局域网，由IEEE 802.1Q工作组负责。

#### 传统大型局域网（校园网）面临的问题

![image-20250501181328159](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501181328159.png)

面临的问题：

1. 局域网由于用交换机连接了众多节点，而交换机又不会隔离广播帧，所以信道容易被广播帧占满。
2. 不安全，局域网内的所有节点被所有其他节点互相感知。其中的敏感重要节点有被攻击的风险。

#### VLAN的原理

![image-20250501181707725](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501181707725.png)

把物理网络划分为多个独立的广播域，**每一个广播域对应一个VID**，即使设备连接在同一个交换机上，也可以被隔离成不同的逻辑链路。

**靠交换机内存储的VLAN ID和端口号（或节点MAC地址）的映射关系。**

##### 基于交换机端口划分（最常见）：

- 每个端口可以分配到一个 VLAN。
- 例如：端口 1-8 属于 VLAN 10（财务部），端口 9-16 属于 VLAN 20（研发部）。

![image-20250501183730964](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501183730964.png)



##### 基于 MAC 地址/IP 地址/协议划分（较少用）：

- 动态 VLAN：根据设备的 MAC 地址或 IP 子网自动分配 VLAN。

![image-20250501183758149](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501183758149.png)

> 由IP地址划分VLAN时，可以将多个不同局域网的节点划分到同一个VLAN虚拟局域网。但要网络层的支持

#### 802.1Q帧的结构

**交换机之间传输**的是**802.1Q帧**（66**4**2N4）不是标准的以太网帧(主机和交换机之间，662N4收发协数验)。多出来的4是用来指明VLAN ID的。

![image-20250501191018019](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501191018019.png)

### 3.6.5 IEEE 802.11无线局域网

![image-20250503160124554](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250503160124554.png)



---



![image-20250501211114117](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501211114117.png)

#### 无线局域网基本概念

![image-20250501211536235](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501211536235.png)

> 可以用portal硬件来将有线网络和无线网络连接成一个更大的局域网。

![image-20250501213125669](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501213125669.png)

- 拓展服务集ESS：将多个AP连接到同一个分配系统，组成一个更大服务集。————子母路由器WIFI覆盖的网络。
- 漫游：一个移动站从一个基本服务集切换到另一个基本服务集，仍然可以保持通信————手机自动连接到信号更强的校园网基站。

以全屋WIFI为例：

![image-20250501213224586](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501213224586.png)

母路由就是路由器+以太网交换机+其他

子路由就是AP

#### 802.11帧的分类

**802.11帧是在无线链路上传播的帧**，有限链路使用以太网帧传播。

![image-20250501215616373](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501215616373.png)

##### 数据帧的格式为：

MAC首部 + 数据帧 + MAC尾部（FCS）

> 分别占 30 + N + 4 字节

MAC首部的格式为：如图

![image-20250501222406023](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250501222406023-17461094476181.png)

MAC首部中的帧控制字段中的**去往AP和来自AP(第9和第10bit)**决定了MAC首部中地址1 、地址2、 地址3 的内容：

**去往AP时（中起止）**

地址1为现阶段目的地址，即AP

地址2为数据发送方，即移动站A

地址3为最终目的地址，即移字站B

**来自AP时（止中起）**

地址1为现阶段的目的地址，即移动站B

地址2为数据的上一跳，即AP

地址3为起点，即移动站A

> 三地址的规律是，帧的现阶段接收方地址，发送方地址，剩下的一个地址。

## 3.7 以太网交换机

### 3.7.1 自学习功能

![image-20250503181556323](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250503181556323.png)

假设各个节点知道彼此的MAC地址。

只有发送方的MAC地址和端口号会被记录到交换表。当交换表上没有接收方的地址时，交换机就会进行广播。

![image-20250503173411682](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250503173411682.png)

当进行第一个发送时，A->C：

交换机1的交换表记录发送方A的MAC地址和端口号，**但由于不知道接收方C的地址，于是就把帧进行广播，发送到除了发送方A以外的所有端口。**当C接收到后验收，其他节点丢弃。当交换机2收到该帧时，也会保存发送方A的MAC地址和端口号，然后也因为不知道接收方C的地址而进行广播。

> 集线器收到任何帧，都会无脑转发给所连接的所有其他端口。

![image-20250503175901024](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250503175901024.png)

### 3.7.2 两种交换方式

![image-20250503181732260](D:\文献\笔记\408计算机网络\3.数据链路层.assets\image-20250503181732260.png)

#### 直通交换

以太网交换机仅接受并处理目的地址（前6个字节）。

#### 存储转发交换

以太网交换机接受并处理整个帧。 
